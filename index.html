<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FLORA & SPORT - Delovni nalog v10.6</title>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/sl.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Prepreči uhajanje elementov izven okvirja */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        :root { 
            --primary: #85b545; 
            --primary-dark: #6a9137; 
            --primary-light: #eef7e5;
            --danger: #ef4444; 
            --danger-light: #fee2e2;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --text-main: #0f172a;
            --text-muted: #64748b;
        }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--gray-100); 
            color: var(--text-main); 
            margin: 0; 
            padding: 0; 
            -webkit-font-smoothing: antialiased; 
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 16px; padding-bottom: 120px; }
        
        /* Kartice */
        .card { 
            background: white; 
            border-radius: 20px; 
            padding: 24px; 
            margin-bottom: 24px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); 
            border: 1px solid rgba(226, 232, 240, 0.8); 
        }
        
        /* Header */
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; 
            padding: 32px 24px; 
            text-align: center; 
            border-radius: 20px; 
            margin-bottom: 32px; 
            box-shadow: 0 10px 25px -5px rgba(133, 181, 69, 0.4); 
            position: relative;
            overflow: hidden;
        }
        .header::after {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
            transform: rotate(30deg); pointer-events: none;
        }
        .header h1 { margin: 0; font-size: 1.75rem; font-weight: 700; letter-spacing: -0.5px; }
        .header p { margin: 8px 0 0 0; opacity: 0.9; font-size: 0.95rem; font-weight: 500; }
        
        /* Form Elementi */
        label { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, select, textarea { 
            width: 100%; 
            padding: 14px 16px; 
            border: 1.5px solid var(--gray-200); 
            border-radius: 12px; 
            font-size: 1rem; 
            background: var(--gray-50); 
            color: var(--text-main);
            transition: all 0.2s ease; 
            appearance: none;
            font-family: inherit;
        }
        
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 40px;
        }

        input:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: var(--primary); 
            background: white;
            box-shadow: 0 0 0 4px var(--primary-light); 
        }

        input.error, select.error {
            border-color: var(--danger);
            background: var(--danger-light);
        }
        
        /* Gumbi */
        .btn { 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 16px 24px; border-radius: 14px; font-weight: 600; font-size: 1.05rem; 
            cursor: pointer; border: none; transition: all 0.2s; width: 100%; 
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(133, 181, 69, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }
        .btn-secondary { background: var(--gray-100); color: var(--text-main); border: 1.5px dashed var(--gray-300); }
        .btn-secondary:hover { background: var(--gray-200); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* UPLOAD SLIK okvir */
        .upload-box {
            width: 100%;
            border: 2px dashed var(--gray-300);
            padding: 32px 24px;
            background: var(--gray-50);
            color: var(--text-muted);
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .upload-box:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary-dark);
        }

        /* Grid sistemi */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; }
        .time-wrapper { display: flex; align-items: center; gap: 8px; background: var(--gray-50); border: 1.5px solid var(--gray-200); border-radius: 12px; padding: 2px; }
        .time-wrapper input { border: none; background: transparent; text-align: center; padding: 12px 4px; border-radius: 8px; }
        .time-wrapper input:focus { box-shadow: none; background: white; }
        .time-wrapper span { font-weight: bold; color: var(--text-muted); }

        /* Custom Checkbox & Radio */
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 12px; background: white; padding: 12px 16px; border-radius: 12px; border: 1.5px solid var(--gray-200); cursor: pointer; transition: all 0.2s; }
        .checkbox-item:hover { border-color: var(--primary-light); background: var(--primary-light); }
        
        .checkbox-item input[type="checkbox"] {
            appearance: none; background: white; margin: 0; padding: 0;
            width: 24px; height: 24px; min-width: 24px;
            border: 2px solid var(--gray-300); border-radius: 6px;
            display: grid; place-content: center; transition: all 0.2s; cursor: pointer;
        }
        .checkbox-item input[type="checkbox"]::before {
            content: ""; width: 12px; height: 12px; transform: scale(0);
            box-shadow: inset 1em 1em white; transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
            transition: 120ms transform ease-in-out;
        }
        .checkbox-item input[type="checkbox"]:checked { background-color: var(--primary); border-color: var(--primary); }
        .checkbox-item input[type="checkbox"]:checked::before { transform: scale(1); }

        /* Radio gumbi za enkratno izbiro (Pasji koši) */
        .checkbox-item input[type="radio"] {
            appearance: none; background: white; margin: 0; padding: 0;
            width: 24px; height: 24px; min-width: 24px;
            border: 2px solid var(--gray-300); border-radius: 50%;
            display: grid; place-content: center; transition: all 0.2s; cursor: pointer;
        }
        .checkbox-item input[type="radio"]::before {
            content: ""; width: 10px; height: 10px; border-radius: 50%; transform: scale(0);
            background-color: white; transition: 120ms transform ease-in-out;
        }
        .checkbox-item input[type="radio"]:checked { background-color: var(--primary); border-color: var(--primary); }
        .checkbox-item input[type="radio"]:checked::before { transform: scale(1); }
        
        /* Slike */
        .img-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 16px; margin-top: 16px; }
        .img-preview { position: relative; aspect-ratio: 1; border-radius: 16px; overflow: hidden; border: 2px solid var(--gray-200); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .img-remove { 
            position: absolute; top: 8px; right: 8px; background: rgba(239, 68, 68, 0.9); color: white; border: none; 
            width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); backdrop-filter: blur(4px);
        }

        /* Sekcije */
        .section-title { 
            display: flex; align-items: center; gap: 10px;
            background: var(--gray-50); padding: 14px 20px; border-radius: 14px; 
            font-weight: 700; color: var(--primary-dark); margin: -10px -10px 24px -10px; 
            font-size: 1.1rem; border-left: 4px solid var(--primary);
        }
        
        .priority-box { background: var(--primary-light); border: 1.5px solid #bbf7d0; border-radius: 14px; padding: 20px; margin-bottom: 24px; }
        
        /* Animacije za nove vrstice */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* Error box */
        .error-summary { background-color: var(--danger-light); border: 1.5px solid #fca5a5; color: #991b1b; padding: 20px; border-radius: 16px; margin-bottom: 24px; font-size: 0.95rem; }
        .error-summary ul { margin: 12px 0 0 24px; padding: 0; }
        .error-summary li { margin-bottom: 6px; }

        @media (max-width: 640px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .time-wrapper { width: 100%; justify-content: space-between; }
            .time-wrapper input { width: 45%; }
            .card { padding: 20px 16px; }
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// --- KONFIGURACIJA ---
const GOOGLE_SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbyOe1qFKy8MlmmO1_utR8rDSspGdw_IC4RL7B_NE4clp0gOvJ10u4MUsqKEIj4DiYWJ/exec';

// --- MODERNE SVG IKONE ---
const Icon = ({ name, size = 24, className = "" }) => {
    const icons = {
        doc: <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />,
        location: <><path strokeLinecap="round" strokeLinejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></>,
        users: <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />,
        truck: <path strokeLinecap="round" strokeLinejoin="round" d="M8 7h12m0 0l3 5v6H8m12-11L17 3H3v16h5m0-2a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 100 4 2 2 0 000-4z" />,
        cog: <><path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></>,
        box: <path strokeLinecap="round" strokeLinejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />,
        trash: <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />,
        camera: <><path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></>,
        check: <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />,
        send: <path strokeLinecap="round" strokeLinejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />,
        clock: <path strokeLinecap="round" strokeLinejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />,
        close: <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
    };
    return (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} width={size} height={size} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            {icons[name]}
        </svg>
    );
};

// --- POMOŽNE FUNKCIJE ---
const compressImage = (file) => {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const MAX_DIMENSION = 800; 

                if (width > height) {
                    if (width > MAX_DIMENSION) {
                        height = Math.round(height * (MAX_DIMENSION / width));
                        width = MAX_DIMENSION;
                    }
                } else {
                    if (height > MAX_DIMENSION) {
                        width = Math.round(width * (MAX_DIMENSION / height));
                        height = MAX_DIMENSION;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                resolve({
                    data: canvas.toDataURL('image/jpeg', 0.6), 
                    name: file.name
                });
            }
        }
    });
};

const timeToDecimal = (ure, minute) => {
    const h = parseFloat(ure) || 0;
    const m = parseFloat(minute) || 0;
    return (h + m / 60).toFixed(2);
};

// --- PODATKI (LISTE) ---
const ULICE = [
    "Baragov trg", "Bavdkova ulica", "Begunjska ulica", "Benedikova ulica", "Bertoncljeva ulica",
    "Bičkova ulica", "Bleiweisova cesta", "Cankarjeva ulica", "Cesta Iva Slavca", "Cesta Jaka Platiše",
    "Cesta Kokrškega odreda", "Cesta na Klanec", "Cesta na Rupo", "Cesta Staneta Žagarja", "Cesta talcev",
    "Cesta 1. maja", "Cicibanova ulica", "Cirilova ulica", "Čirče", "Delavska cesta", "Detelova ulica",
    "Dolenčeva ulica", "Dražgoška ulica", "Drolčevo naselje", "Drulovka", "Finžgarjeva ulica",
    "Gasilska ulica", "Glavni trg", "Gogalova ulica", "Gorenjesavska cesta", "Gosposvetska ulica",
    "Gradnikova ulica", "Gregorčičeva ulica", "Gregoričeva ulica", "Grintovška ulica", "Grmičeva ulica",
    "Gubčeva ulica", "Hafnarjeva pot", "Huje", "Jahačev prehod", "Jelenčeva ulica", "Jenkova ulica",
    "Jernejeva ulica", "Ješetova ulica", "Jezerska cesta", "Jurčičeva ulica", "Kajuhova ulica",
    "Kalinškova ulica", "Kališka ulica", "Kebetova ulica", "Kidričeva cesta", "Kocjanova ulica",
    "Kokrški breg", "Kokrški log", "Kolodvorska cesta", "Komenskega ulica", "Kopališka ulica",
    "Koroška cesta", "Kovačičeva ulica", "Krajevna pot", "Krašnova ulica", "Kriška ulica",
    "Križnarjeva pot", "Krožna ulica", "Kurirska pot", "Kutinova ulica", "Laze", "Levstikova ulica",
    "Likozarjeva ulica", "Ljubljanska cesta", "Luznarjeva ulica", "Maistrov trg", "Mandeljčeva pot",
    "Matajčeva ulica", "Medetova ulica", "Mencingerjeva ulica", "Mladinska ulica", "Mlakarjeva ulica",
    "Mlekarska ulica", "Mrakova ulica", "Na skali", "Nadižarjeva ulica", "Nartnikova ulica",
    "Na Vinograd", "Nazorjeva ulica", "Oldhamska cesta", "Oprešnikova ulica", "Pante", "Partizanska cesta",
    "Pintarjeva ulica", "Planina", "Pod gradom", "Poštna ulica", "Pot na Jošta", "Pot na kolodvor",
    "Pot v Bitnje", "Pot v puškarno", "Pot v Torklo", "Pot za krajem", "Prečna ulica", "Prešernova ulica",
    "Pševska cesta", "Reginčeva ulica", "Reševa ulica", "Retljeva ulica", "Rotarjeva ulica", "Rožna ulica",
    "Ručigajeva cesta", "Rupa", "Savska cesta", "Savska loka", "Sejmišče", "Seljakovo naselje",
    "Sitarska pot", "Skalica", "Skokova ulica", "Slovenski trg", "Smledniška cesta", "Sorška ulica",
    "Stara cesta", "Staretova ulica", "Storžiška ulica", "Stošičeva ulica", "Stražiška ulica",
    "Stritarjeva ulica", "Strmov", "Struževo", "Šempetrska ulica", "Šiškovo naselje", "Škofjeloška cesta",
    "Škrlovec", "Šmarjetna gora", "Šmidova ulica", "Šolska ulica", "Šorlijeva ulica", "Špikova ulica",
    "Štirnova ulica", "Šuceva ulica", "Tavčarjeva ulica", "Tekstilna ulica", "Tomažičeva ulica",
    "Tominčeva cesta", "Tomšičeva ulica", "Trg Prešernove brigade", "Trg Rivoli", "Triglavska ulica",
    "Trojarjeva ulica", "Trubarjev trg", "Ulica Draga Brezarja", "Ulica Franca Rozmana - Staneta",
    "Ulica Gorenjskega odreda", "Ulica Janeza Puharja", "Ulica Janka Puclja", "Ulica Juleta Gabrovška",
    "Ulica Lojzeta Hrovata", "Ulica Milene Korbarjeve", "Ulica Mirka Vadnova", "Ulica mladinskih brigad",
    "Ulica Nikole Tesle", "Ulica Rudija Papeža", "Ulica Tatjane Odrove", "Ulica Tončka Dežmana",
    "Ulica Tuga Vidmarja", "Ulica Vide Šinkovčeve", "Ulica XXXI. divizije", "Ulica 1. avgusta",
    "Valjavčeva ulica", "Vidmarjeva ulica", "Vodopivčeva ulica", "Vrečkova ulica", "Vrtna ulica",
    "Zadružna ulica", "Zariška ulica", "Zasavska cesta", "Zevnikova ulica", "Zlatnarjeva pot",
    "Zlato polje", "Zoisova ulica", "Žanova ulica", "Žeškova ulica", "Župančičeva ulica"
];

const LISTS = {
    narocniki: ['Mestna Občina Kranj', 'Drugo'],
    storitve: [
        'mok01 Sajenje cvetja v grede', 'mok02 Sajenje trajnic in vrtnic', 'mok03 Zasaditev korit',
        'mok04-06 Oskrba cvetja in trajnic', 'mok07-09 Oskrba grmovnic in živih mej', 'mok10 Zasaditev živih mej',
        'mok11 Sajenje grmovnic', 'mok12 Popravilo zelenic', 'mok13 Dobava plodne zemlje', 'mok15 Setev trave',
        'mok16 Odstranitev grmovnic', 'mok17 Odstranitev invazivk', 'mok18 Sezonsko prestavljanje korit',
        'mok20 Obrez dreves', 'mok21 Posek dreves', 'mok22 Odščip vej', 'mok23 Sajenje dreves',
        'mok24 Odstranitev panjev', 'mok25 Zalivanje dreves', 'mok26 Arboristični pregled',
        'mok27 Spomladansko čiščenje', 'mok28 Jesensko čiščenje listja', 'mok29 Košnja zelenih površin',
        'mok30 Odvoz odreza', 'mok32a Vzdrževanje igral', 'mok32b Vzdrževanje urbane opreme',
        'mok34 Čiščenje pasjih košev', 'mok35 Vzdrževanje čistoče', 'mok36 Nepredvidena dela', 'Drugo'
    ],
    obmocja: [
        '1. Ljubljanska', '2. Center', '3. Vodovodni stolp', '4. Šorlijevo', '5. Zlato polje', '6. Planina',
        '7. Planina II', '8. Planina III', '9. Primskovo', '10. Čirče', '11. Stražišče - Besnica',
        '12. Drulovka', '13. Savska', '14. Rudija Šeliga', '15. Brdo', 'Drugo'
    ],
    delavci: [
        'Anja STANONIK', 'Bine KUMER', 'Boštjan BIZJAK', 'David ZAVRL', 'Dejan PETKOVSKI', 
        'Mitja POTOČNIK', 'Robert ERDELJEC', 'Simon REPNIK', 'Uroš PINTAR', 'Zoran MIČANOVIĆ', 
        'Zoran STRUPI', 'PAUNOVSKI 1', 'PAUNOVSKI 2', 'PAUNOVSKI 3', 'PAUNOVSKI 4', 'Drugo'
    ],
    vozila: [
        'KR AA-131', 'KR AF-471', 'KR DK-834', 'KR GS-288', 'KR JR-085', 'KR LH-350', 
        'KR MA-821', 'KR RH-013', 'KR TL-851', 'KR VL-155', 'Drugo'
    ],
    stroji: [
        'Agregat', 'Dvižna košara', 'El. orodje', 'Freza finišer', 'Freza za štore',
        'Komunalna kosilnica', 'Mini bager', 'Mlin za veje', 'Motorna freza', 'Motorna kosa',
        'Motorna žaga', 'Motorne škarje', 'Motorni pihalnik', 'Odvoz odpadkov', 
        'Profesionalna komunalna kosilnica', 'Ročni pihalnik', 'Samohodna kosilnica', 
        'Sejalnica za travo', 'Sesalec listja', 'Traktor s prikolico', 
        'Viličar', 'Višinski obrezovalnik', 'Drugo'
    ],
    materiali: ['Drobni material', 'Filc', 'Gnojilo', 'Količki', 'Kompost', 'Mivka', 'Pesek', 'Polovičke', 'Travno seme', 'Vrečke', 'Vrečke v roli', 'Zastirka', 'Zemlja', 'Drugo'],
    odpadki: ['Invazivke', 'Listje', 'Mešano', 'Mivka', 'Pesek', 'Trava', 'Veje', 'Vreče', 'Zemlja', 'Drugo'],
    enote: ['kg', 'l', 'm', 'm²', 'm³', 'kos', 'vreča', 'Drugo']
};

const STORITVE_STROJI = {
    'mok01': ['Ročni pihalnik', 'Traktor s prikolico'],
    'mok02': ['Ročni pihalnik', 'Traktor s prikolico'],
    'mok03': ['Ročni pihalnik', 'Traktor s prikolico', 'Viličar'],
    'mok04': ['Ročni pihalnik', 'Motorne škarje', 'Traktor s prikolico'],
    'mok07': ['Ročni pihalnik', 'Motorne škarje', 'Motorna žaga', 'Višinski obrezovalnik', 'Traktor s prikolico'],
    'mok10': ['Ročni pihalnik', 'Mini bager', 'Sejalnica za travo', 'Traktor s prikolico'],
    'mok11': ['Ročni pihalnik', 'Mini bager', 'Traktor s prikolico'],
    'mok12': ['Ročni pihalnik', 'Sejalnica za travo', 'Motorna freza', 'Traktor s prikolico'],
    'mok13': ['Ročni pihalnik', 'Traktor s prikolico', 'Mini bager'],
    'mok15': ['Ročni pihalnik', 'Sejalnica za travo', 'Freza finišer', 'Motorna freza', 'Traktor s prikolico'],
    'mok16': ['Ročni pihalnik', 'Mini bager', 'Motorna žaga', 'Motorne škarje', 'Traktor s prikolico'],
    'mok17': ['Ročni pihalnik', 'Mini bager', 'Motorna žaga', 'Motorne škarje', 'Traktor s prikolico'],
    'mok18': ['Ročni pihalnik', 'Traktor s prikolico', 'Viličar'],
    'mok20': ['Ročni pihalnik', 'Dvižna košara', 'Motorna žaga', 'Motorne škarje', 'Višinski obrezovalnik', 'Mlin za veje', 'Traktor s prikolico'],
    'mok21': ['Ročni pihalnik', 'Dvižna košara', 'Motorna žaga', 'Motorne škarje', 'Mlin za veje', 'Traktor s prikolico'],
    'mok22': ['Ročni pihalnik', 'Dvižna košara', 'Motorna žaga', 'Motorne škarje', 'Mlin za veje', 'Traktor s prikolico'],
    'mok23': ['Ročni pihalnik', 'Mini bager', 'Traktor s prikolico'],
    'mok24': ['Ročni pihalnik', 'Motorna freza', 'Freza za štore'],
    'mok25': ['Ročni pihalnik', 'Traktor s prikolico'],
    'mok26': ['Ročni pihalnik', 'Dvižna košara', 'Višinski obrezovalnik'],
    'mok27': ['Ročni pihalnik', 'Motorni pihalnik', 'Sesalec listja', 'Traktor s prikolico'],
    'mok28': ['Ročni pihalnik', 'Motorni pihalnik', 'Sesalec listja', 'Traktor s prikolico'],
    'mok29': ['Ročni pihalnik', 'Komunalna kosilnica', 'Samohodna kosilnica', 'Motorna kosa', 'Traktor s prikolico'],
    'mok30': ['Ročni pihalnik', 'Traktor s prikolico', 'Odvoz odpadkov'],
    'mok32': ['Ročni pihalnik', 'El. orodje', 'Agregat'],
    'mok34': ['Ročni pihalnik'],
    'mok35': ['Ročni pihalnik', 'Sesalec listja', 'Traktor s prikolico'],
    'mok36': ['Ročni pihalnik', 'Viličar', 'Mini bager', 'Traktor s prikolico']
};

// --- INITIAL STATE ---
const INITIAL_STATE = {
    narocnik: 'Mestna Občina Kranj', narocnikDrugo: '', datum: '',
    storitev: '', storitevDrugo: '',
    storitevVisine: Array(5).fill().map(() => ({ selected: false, kolicina: '' })),
    storitevParki: [], 
    storitevPasjiKosi: [], 
    storitevKolicina: '', 
    obmocjeKoncano: Array(15).fill().map(() => ({ obmocje: '', drugo: '' })),
    obmocjeNedokoncano: Array(15).fill().map(() => ({ obmocje: '', drugo: '' })),
    delavci: Array(15).fill().map(() => ({ ime: '', ure: '', minute: '', drugaIme: '' })),
    vozila: Array(5).fill().map(() => ({ vozilo: '', km: '', drugaReg: '' })),
    priorityStroji: {},
    dodatniStroji: Array(5).fill().map(() => ({ naziv: '', ure: '', minute: '', drugaNaziv: '' })),
    materiali: Array(5).fill().map(() => ({ material: '', vrsta: '', drugMaterial: '', kolicina: '', enota: '' })),
    odpadki: Array(2).fill().map(() => ({ vrsta: '', drugaVrsta: '', kolicina: '', enota: '' })),
    slike: [], opombe: '', podpisOdgovornega: '', podpisDrugo: ''
};

// --- KOMPONENTE ---

const TimeInput = ({ ure, minute, onChangeUre, onChangeMinute, hasError }) => (
    <div className="time-wrapper" style={hasError ? {borderColor: 'var(--danger)', background: 'var(--danger-light)'} : {}}>
        <input type="number" min="0" max="24" placeholder="h" value={ure} onChange={(e) => onChangeUre(e.target.value)} />
        <span>:</span>
        <input type="number" min="0" max="59" step="5" placeholder="min" value={minute} onChange={(e) => onChangeMinute(e.target.value)} />
    </div>
);

function App() {
    const loadState = () => {
        const saved = localStorage.getItem('dn_flora_state');
        return saved ? JSON.parse(saved) : INITIAL_STATE;
    };

    const [formData, setFormData] = useState(loadState);
    const [status, setStatus] = useState({ type: '', text: '' });
    const [loading, setLoading] = useState(false);
    const [uploadProgress, setUploadProgress] = useState(0);
    const [validationErrors, setValidationErrors] = useState([]);
    const datePickerRef = useRef(null);

    useEffect(() => {
        localStorage.setItem('dn_flora_state', JSON.stringify(formData));
    }, [formData]);

    useEffect(() => {
        if (datePickerRef.current) {
            flatpickr(datePickerRef.current, {
                locale: 'sl', dateFormat: 'Y-m-d', defaultDate: formData.datum,
                onChange: (dates, str) => updateField('datum', str)
            });
        }
    }, []);

    const updateField = (field, val) => {
        setFormData(p => ({ ...p, [field]: val }));
        if(validationErrors.length) setValidationErrors([]);
    };
    
    const updateArrayItem = (arr, idx, key, val) => {
        setFormData(p => {
            const newArr = [...p[arr]];
            newArr[idx] = { ...newArr[idx], [key]: val };
            if (arr === 'delavci' && idx > 0 && key === 'ime' && val && !newArr[idx].ure && newArr[0].ure) {
                newArr[idx].ure = newArr[0].ure;
                newArr[idx].minute = newArr[0].minute;
            }
            return { ...p, [arr]: newArr };
        });
        if(validationErrors.length) setValidationErrors([]);
    };

    const handleImageUpload = async (e) => {
        const files = Array.from(e.target.files);
        
        if (formData.slike.length + files.length > 5) {
            alert('⚠️ Opozorilo: Dodate lahko največ 5 slik hkrati, sicer bo pošiljanje prekinjeno.');
            e.target.value = '';
            return;
        }

        setLoading(true);
        const newImages = [];
        
        for (const file of files) {
            try {
                const compressed = await compressImage(file);
                newImages.push({ ...compressed, timestamp: new Date().toISOString() });
            } catch (err) {
                console.error("Napaka pri sliki", err);
            }
        }
        
        setFormData(p => ({ ...p, slike: [...p.slike, ...newImages] }));
        setLoading(false);
        e.target.value = ''; 
    };

    const getPriorityStroji = () => {
        const code = formData.storitev.substring(0, 5).replace('-', '');
        let key = Object.keys(STORITVE_STROJI).find(k => formData.storitev.startsWith(k));
        return key ? STORITVE_STROJI[key] : ['Ročni pihalnik'];
    };

    const validate = () => {
        const errs = [];
        
        if (!formData.datum) errs.push('Datum je obvezen.');
        if (!formData.storitev) errs.push('Storitev je obvezna.');
        
        formData.delavci.forEach((d, i) => {
            if (d.ime && (!d.ure && !d.minute)) errs.push(`Delavec ${i+1}: Vpiši ure ali minute!`);
        });

        formData.vozila.forEach((v, i) => {
            if (v.vozilo && !v.km) errs.push(`Vozilo ${i+1}: Vpiši kilometre!`);
        });

        formData.dodatniStroji.forEach((s, i) => {
            if (s.naziv && (!s.ure && !s.minute)) errs.push(`Stroj ${i+1}: Vpiši čas uporabe!`);
        });

        formData.materiali.forEach((m, i) => {
            if (m.material && !m.kolicina) errs.push(`Material ${i+1}: Vpiši količino!`);
        });

        formData.odpadki.forEach((o, i) => {
            if (o.vrsta && !o.kolicina) errs.push(`Odpadki ${i+1}: Vpiši količino!`);
        });

        formData.obmocjeKoncano.forEach((o, i) => {
            if (o.obmocje === 'Drugo' && !o.drugo) errs.push(`Lokacija Končano ${i+1}: Vpiši ulico!`);
        });
        formData.obmocjeNedokoncano.forEach((o, i) => {
            if (o.obmocje === 'Drugo' && !o.drugo) errs.push(`Lokacija Nedokončano ${i+1}: Vpiši ulico!`);
        });
        
        if (!formData.podpisOdgovornega && !formData.podpisDrugo) errs.push('Manjka podpis.');
        
        return errs;
    };

    const handleSubmit = async () => {
        const errors = validate();
        setValidationErrors(errors);
        
        if (errors.length) {
            setStatus({ type: 'error', text: 'Prosim odpravite napake označene z rdečo.' });
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return;
        }

        setLoading(true);
        setUploadProgress(0);
        setStatus({ type: 'info', text: 'Pripravljam in pošiljam podatke...' });

        const timeoutDuration = formData.slike.length > 0 ? 3000 + (formData.slike.length * 1500) : 2000;
        const progressIntervalTime = 100;
        const increment = 90 / (timeoutDuration / progressIntervalTime);
        
        const progressInterval = setInterval(() => {
            setUploadProgress(prev => {
                if (prev >= 90) return 90;
                return prev + increment;
            });
        }, progressIntervalTime);

        const payload = {
            imeNaloga: `${formData.datum} ${formData.storitev.split(' ')[0]}`,
            narocnik: formData.narocnik === 'Drugo' ? formData.narocnikDrugo : formData.narocnik,
            datum: formData.datum,
            storitev: formData.storitev === 'Drugo' || formData.storitev.includes('Nepredvidena') 
                ? (formData.storitevDrugo || formData.storitev) : formData.storitev,
            obmocjeKoncano: formData.obmocjeKoncano.map(o => o.obmocje === 'Drugo' ? o.drugo : o.obmocje).filter(Boolean).join(', '),
            obmocjeNedokoncano: formData.obmocjeNedokoncano.map(o => o.obmocje === 'Drugo' ? o.drugo : o.obmocje).filter(Boolean).join(', '),
            opombe: formData.opombe,
            podpis: formData.podpisOdgovornega === 'Drugo' ? formData.podpisDrugo : formData.podpisOdgovornega
        };

        // Združimo opis storitve in izbrane opcije (parki / koši / višine)
        let kolicinaTxt = '';
        if (formData.storitevKolicina) kolicinaTxt = `${formData.storitevKolicina}`;
        
        // Dodajanje parkov v opis
        if (formData.storitevParki && formData.storitevParki.length > 0) {
            kolicinaTxt += (kolicinaTxt ? ' | ' : '') + `Parki: ${formData.storitevParki.join(', ')}`;
        }

        // Dodajanje pasjih košev v opis
        if (formData.storitevPasjiKosi && formData.storitevPasjiKosi.length > 0) {
            kolicinaTxt += (kolicinaTxt ? ' | ' : '') + `Koši: ${formData.storitevPasjiKosi.join(', ')}`;
        }

        // Dodajanje višin obrezovanja
        const visine = formData.storitevVisine.filter(v => v.selected).map(v => `${v.kolicina || 0} kos`).join(', ');
        if(visine) kolicinaTxt += (kolicinaTxt ? ' | ' : '') + visine;
        
        payload.visinaKolicina = kolicinaTxt;

        formData.delavci.forEach((d, i) => {
            if (d.ime) {
                payload[`delavec${i+1}`] = d.ime === 'Drugo' ? d.drugaIme : d.ime;
                payload[`delavec${i+1}Ure`] = timeToDecimal(d.ure, d.minute);
                payload[`delavec${i+1}Enota`] = 'ur';
            }
        });

        formData.vozila.forEach((v, i) => {
            if (v.vozilo) {
                payload[`vozilo${i+1}`] = v.vozilo === 'Drugo' ? v.drugaReg : v.vozilo;
                payload[`vozilo${i+1}Km`] = v.km;
                payload[`vozilo${i+1}Enota`] = 'km';
            }
        });

        let sIdx = 1;
        getPriorityStroji().forEach(sName => {
            const data = formData.priorityStroji[sName];
            if (data && (data.ure || data.minute)) {
                payload[`stroj${sIdx}`] = sName;
                payload[`stroj${sIdx}Ure`] = timeToDecimal(data.ure, data.minute);
                payload[`stroj${sIdx}Enota`] = 'ur';
                sIdx++;
            }
        });
        formData.dodatniStroji.forEach(s => {
            if (s.naziv && sIdx <= 10) {
                payload[`stroj${sIdx}`] = s.naziv === 'Drugo' ? s.drugaNaziv : s.naziv;
                payload[`stroj${sIdx}Ure`] = timeToDecimal(s.ure, s.minute);
                payload[`stroj${sIdx}Enota`] = 'ur';
                sIdx++;
            }
        });

        formData.materiali.forEach((m, i) => {
            if (m.material) {
                let name = m.material === 'Drugo' ? m.drugMaterial : m.material;
                if (m.vrsta) name += ` ${m.vrsta}`;
                payload[`material${i+1}`] = name;
                payload[`material${i+1}Kolicina`] = m.kolicina;
                payload[`material${i+1}Enota`] = m.enota;
            }
        });
        
        formData.odpadki.forEach((o, i) => {
             if (o.vrsta) {
                payload[`odpadki${i+1}`] = o.vrsta === 'Drugo' ? o.drugaVrsta : o.vrsta;
                payload[`odpadki${i+1}Kolicina`] = o.kolicina;
                payload[`odpadki${i+1}Enota`] = o.enota;
            }
        });

        if (formData.slike.length) {
            payload.slikeCount = formData.slike.length;
            formData.slike.forEach((img, i) => {
                payload[`slika${i+1}Name`] = img.name;
                payload[`slika${i+1}Data`] = img.data;
            });
        }

        try {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = GOOGLE_SHEETS_API_URL;
            form.target = 'hidden-iframe';
            form.enctype = 'multipart/form-data'; 
            
            Object.entries(payload).forEach(([key, val]) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = val || '';
                form.appendChild(input);
            });

            let iframe = document.getElementById('hidden-iframe');
            if (!iframe) {
                iframe = document.createElement('iframe');
                iframe.id = 'hidden-iframe';
                iframe.name = 'hidden-iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }

            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);

            setTimeout(() => {
                clearInterval(progressInterval);
                setUploadProgress(100);
                
                setTimeout(() => {
                    setLoading(false);
                    setStatus({ type: 'success', text: '✅ Uspešno poslano v sistem!' });
                    setValidationErrors([]);
                    localStorage.removeItem('dn_flora_state');
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    setTimeout(() => {
                        if(confirm('Nalog je bil uspešno shranjen! Želite očistiti obrazec in začeti znova?')) {
                            setFormData(INITIAL_STATE);
                            setStatus({ type: '', text: '' });
                            setUploadProgress(0);
                        } else {
                            setUploadProgress(0);
                        }
                    }, 500);

                }, 400); 

            }, timeoutDuration);

        } catch (e) {
            clearInterval(progressInterval);
            setLoading(false);
            setUploadProgress(0);
            setStatus({ type: 'error', text: 'Napaka pri pošiljanju: ' + e.message });
        }
    };

    return (
        <div className="container">
            <div className="header">
                <h1>Delovni nalog</h1>
                <p>FLORA & SPORT d.o.o.</p>
            </div>

            <datalist id="ulice-list">
                {ULICE.map(ulica => <option key={ulica} value={ulica} />)}
            </datalist>

            {validationErrors.length > 0 && (
                <div className="error-summary fade-in">
                    <strong>⚠️ Prosim dopolnite manjkajoče podatke:</strong>
                    <ul>
                        {validationErrors.map((err, i) => <li key={i}>{err}</li>)}
                    </ul>
                </div>
            )}

            {/* OSNOVNI PODATKI */}
            <div className="card">
                <div className="section-title">
                    <Icon name="doc" /> Osnovni podatki
                </div>
                
                <div style={{marginBottom: 20}}>
                    <label>Naročnik</label>
                    <select value={formData.narocnik} onChange={e => updateField('narocnik', e.target.value)}>
                        {LISTS.narocniki.map(n => <option key={n} value={n}>{n}</option>)}
                    </select>
                    {formData.narocnik === 'Drugo' && (
                        <input className="mt-2 fade-in" placeholder="Vpiši naročnika" value={formData.narocnikDrugo} onChange={e => updateField('narocnikDrugo', e.target.value)} style={{marginTop:12}}/>
                    )}
                </div>

                <div className="grid-2" style={{marginBottom: 20}}>
                    <div>
                        <label>Datum</label>
                        <input ref={datePickerRef} placeholder="Izberi datum..." readOnly className={!formData.datum && validationErrors.length ? 'error' : ''} />
                    </div>
                    <div>
                        <label>Storitev</label>
                        <select value={formData.storitev} onChange={e => { updateField('storitev', e.target.value); updateField('priorityStroji', {}); }} className={!formData.storitev && validationErrors.length ? 'error' : ''}>
                            <option value="">Izberi storitev...</option>
                            {LISTS.storitve.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                    </div>
                </div>

                {formData.storitev === 'Drugo' && (
                    <div className="fade-in" style={{marginBottom: 20}}>
                        <label>Vpiši storitev</label>
                        <input value={formData.storitevDrugo} onChange={e => updateField('storitevDrugo', e.target.value)} placeholder="Opis storitve..." />
                    </div>
                )}
                
                {/* PARKI - Če je Vzdrževanje čistoče */}
                {formData.storitev.includes('Vzdrževanje čistoče') && (
                    <div className="fade-in" style={{marginBottom: 20}}>
                        <label>Izbrani parki (lahko označiš več)</label>
                        <div className="checkbox-group">
                            {['mok35a Prešernov gaj', 'mok35b Park slovenske himne', 'mok35c Igrišče Krtek', 'mok35d Igrišče Savica', 'mok35e Bleiweisov park'].map(park => (
                                <label key={park} className="checkbox-item">
                                    <input type="checkbox" 
                                           checked={formData.storitevParki.includes(park)} 
                                           onChange={(e) => {
                                               const current = formData.storitevParki || [];
                                               if (e.target.checked) {
                                                   updateField('storitevParki', [...current, park]);
                                               } else {
                                                   updateField('storitevParki', current.filter(p => p !== park));
                                               }
                                           }} 
                                    />
                                    <span style={{flex:1, textTransform: 'none', fontWeight: 500, margin: 0}}>{park}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                )}

                {/* PASJI KOŠI - Če je Čiščenje pasjih košev (Radio Gumbi) */}
                {formData.storitev.includes('Čiščenje pasjih košev') && (
                    <div className="fade-in" style={{marginBottom: 20}}>
                        <label>Vrsta košev (izberi eno opcijo)</label>
                        <div className="checkbox-group">
                            {['mok34a Čiščenje košev za pasje iztrebke na 7 dni', 'mok34b Čiščenje košev za pasje iztrebke na 14 dni'].map(kos => (
                                <label key={kos} className="checkbox-item">
                                    <input type="radio" 
                                           name="pasji_kosi_radio"
                                           checked={formData.storitevPasjiKosi.includes(kos)} 
                                           onChange={(e) => {
                                               if (e.target.checked) {
                                                   updateField('storitevPasjiKosi', [kos]);
                                               }
                                           }} 
                                    />
                                    <span style={{flex:1, textTransform: 'none', fontWeight: 500, margin: 0}}>{kos}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                )}

                {/* VIŠINE - Če je Obrez ali Posek */}
                {(formData.storitev.includes('Obrez') || formData.storitev.includes('Posek')) && (
                    <div className="fade-in" style={{marginBottom: 20}}>
                        <label>Višine (kos)</label>
                        <div className="checkbox-group">
                            {['do 5m', '5-10m', '10-15m', 'nad 15m'].map((label, idx) => (
                                <label key={idx} className="checkbox-item">
                                    <input type="checkbox" checked={formData.storitevVisine[idx].selected} 
                                           onChange={() => {
                                               const newV = [...formData.storitevVisine];
                                               newV[idx].selected = !newV[idx].selected;
                                               updateField('storitevVisine', newV);
                                           }} />
                                    <span style={{flex:1, textTransform: 'none', fontWeight: 500, margin: 0}}>{label}</span>
                                    {formData.storitevVisine[idx].selected && 
                                        <input type="number" placeholder="Kol." style={{width: 80, padding: 8}} 
                                               value={formData.storitevVisine[idx].kolicina}
                                               onClick={e => e.preventDefault()}
                                               onChange={(e) => {
                                                    const newV = [...formData.storitevVisine];
                                                    newV[idx].kolicina = e.target.value;
                                                    updateField('storitevVisine', newV);
                                               }} />
                                    }
                                </label>
                            ))}
                        </div>
                    </div>
                )}
                 
                 <div style={{marginBottom: 8}}>
                     <label>Količina / Dodaten opis</label>
                     <input type="text" value={formData.storitevKolicina} onChange={e => updateField('storitevKolicina', e.target.value)} placeholder="npr. 50 m2 ali posebnosti" />
                 </div>
            </div>

            {/* LOKACIJA */}
            <div className="card">
                <div className="section-title">
                    <Icon name="location" /> Lokacija dela
                </div>
                <div className="grid-2">
                    <div>
                        <label style={{color: '#16a34a'}}><Icon name="check" size={18} /> Končano</label>
                        {formData.obmocjeKoncano.map((item, idx) => (
                            (idx === 0 || formData.obmocjeKoncano[idx-1].obmocje) && (
                                <div key={idx} className={idx > 0 ? "fade-in" : ""} style={{marginBottom: 12}}>
                                    <select value={item.obmocje} onChange={e => updateArrayItem('obmocjeKoncano', idx, 'obmocje', e.target.value)}>
                                        <option value="">Izberi območje...</option>
                                        {LISTS.obmocja.map(o => <option key={o} value={o}>{o}</option>)}
                                    </select>
                                    {item.obmocje === 'Drugo' && (
                                        <input 
                                            list="ulice-list" placeholder="Začni tipkati ulico..." 
                                            value={item.drugo} onChange={e => updateArrayItem('obmocjeKoncano', idx, 'drugo', e.target.value)} 
                                            className={"fade-in " + ((!item.drugo && validationErrors.length > 0) ? 'error' : '')}
                                            style={{marginTop: 8}} 
                                        />
                                    )}
                                </div>
                            )
                        ))}
                    </div>
                    <div>
                        <label style={{color: '#ea580c'}}><Icon name="clock" size={18} /> Nedokončano</label>
                        {formData.obmocjeNedokoncano.map((item, idx) => (
                            (idx === 0 || formData.obmocjeNedokoncano[idx-1].obmocje) && (
                                <div key={idx} className={idx > 0 ? "fade-in" : ""} style={{marginBottom: 12}}>
                                    <select value={item.obmocje} onChange={e => updateArrayItem('obmocjeNedokoncano', idx, 'obmocje', e.target.value)}>
                                        <option value="">Izberi območje...</option>
                                        {LISTS.obmocja.map(o => <option key={o} value={o}>{o}</option>)}
                                    </select>
                                    {item.obmocje === 'Drugo' && (
                                        <input 
                                            list="ulice-list" placeholder="Začni tipkati ulico..." 
                                            value={item.drugo} onChange={e => updateArrayItem('obmocjeNedokoncano', idx, 'drugo', e.target.value)} 
                                            className={"fade-in " + ((!item.drugo && validationErrors.length > 0) ? 'error' : '')}
                                            style={{marginTop: 8}} 
                                        />
                                    )}
                                </div>
                            )
                        ))}
                    </div>
                </div>
            </div>

            {/* DELAVCI */}
            <div className="card">
                <div className="section-title">
                    <Icon name="users" /> 1. Prisotni delavci
                </div>
                {formData.delavci.map((d, idx) => (
                    (idx === 0 || formData.delavci[idx-1].ime) && (
                        <div key={idx} className={idx > 0 ? "fade-in" : ""} style={{display: 'flex', gap: 12, marginBottom: 16, alignItems: 'flex-start'}}>
                            <div style={{flex: 2}}>
                                <select value={d.ime} onChange={e => updateArrayItem('delavci', idx, 'ime', e.target.value)}>
                                    <option value="">Delavec {idx + 1}...</option>
                                    {LISTS.delavci.filter(x => x === 'Drugo' || !formData.delavci.find((wd, wi) => wi !== idx && wd.ime === x)).map(x => (
                                        <option key={x} value={x}>{x}</option>
                                    ))}
                                </select>
                                {d.ime === 'Drugo' && <input placeholder="Ime in priimek..." value={d.drugaIme} onChange={e => updateArrayItem('delavci', idx, 'drugaIme', e.target.value)} style={{marginTop:8}} className="fade-in" />}
                            </div>
                            <div style={{width: 140}}>
                                <TimeInput ure={d.ure} minute={d.minute} 
                                    hasError={d.ime && !d.ure && !d.minute && validationErrors.length > 0}
                                    onChangeUre={v => updateArrayItem('delavci', idx, 'ure', v)}
                                    onChangeMinute={v => updateArrayItem('delavci', idx, 'minute', v)} />
                            </div>
                        </div>
                    )
                ))}
            </div>

            {/* VOZILA */}
            <div className="card">
                <div className="section-title">
                    <Icon name="truck" /> 2. Potni nalog
                </div>
                {formData.vozila.map((v, idx) => (
                    (idx === 0 || formData.vozila[idx-1].vozilo) && (
                        <div key={idx} className={"grid-2 " + (idx > 0 ? "fade-in" : "")} style={{marginBottom: 16}}>
                            <div>
                                <select value={v.vozilo} onChange={e => updateArrayItem('vozila', idx, 'vozilo', e.target.value)}>
                                    <option value="">Izberi vozilo {idx + 1}...</option>
                                    {LISTS.vozila.filter(x => x === 'Drugo' || !formData.vozila.find((wv, wi) => wi !== idx && wv.vozilo === x)).map(x => (
                                        <option key={x} value={x}>{x}</option>
                                    ))}
                                </select>
                                {v.vozilo === 'Drugo' && <input placeholder="Vpiši registrsko..." value={v.drugaReg} onChange={e => updateArrayItem('vozila', idx, 'drugaReg', e.target.value)} style={{marginTop:8}} className="fade-in" />}
                            </div>
                            <input type="number" placeholder="Prevoženi km" value={v.km} 
                                className={v.vozilo && !v.km && validationErrors.length > 0 ? 'error' : ''}
                                onChange={e => updateArrayItem('vozila', idx, 'km', e.target.value)} />
                        </div>
                    )
                ))}
            </div>

            {/* STROJI */}
            <div className="card">
                <div className="section-title">
                    <Icon name="cog" /> 3. Strojno delo
                </div>
                {formData.storitev && (
                    <div className="priority-box fade-in">
                        <label style={{color: '#166534', marginBottom: 16}}>Priporočeni stroji za izbrano delo:</label>
                        {getPriorityStroji().map(stroj => (
                            <div key={stroj} style={{display: 'flex', justifyContent:'space-between', alignItems:'center', gap: 12, marginBottom: 12}}>
                                <span style={{fontWeight: 500}}>{stroj}</span>
                                <div style={{width: 140}}>
                                    <TimeInput 
                                        ure={formData.priorityStroji[stroj]?.ure || ''} 
                                        minute={formData.priorityStroji[stroj]?.minute || ''}
                                        onChangeUre={v => setFormData(p => ({...p, priorityStroji: {...p.priorityStroji, [stroj]: {...(p.priorityStroji[stroj] || {}), ure: v} } }))}
                                        onChangeMinute={v => setFormData(p => ({...p, priorityStroji: {...p.priorityStroji, [stroj]: {...(p.priorityStroji[stroj] || {}), minute: v} } }))}
                                    />
                                </div>
                            </div>
                        ))}
                    </div>
                )}
                
                <label style={{marginBottom: 12}}>Ostali stroji:</label>
                {formData.dodatniStroji.map((s, idx) => (
                    (idx === 0 || formData.dodatniStroji[idx-1].naziv) && (
                        <div key={idx} className={idx > 0 ? "fade-in" : ""} style={{display: 'flex', gap: 12, marginBottom: 16}}>
                            <div style={{flex: 2}}>
                                <select value={s.naziv} onChange={e => updateArrayItem('dodatniStroji', idx, 'naziv', e.target.value)}>
                                    <option value="">Izberi stroj...</option>
                                    {LISTS.stroji.filter(x => !getPriorityStroji().includes(x)).map(x => <option key={x} value={x}>{x}</option>)}
                                </select>
                                {s.naziv === 'Drugo' && <input placeholder="Naziv stroja..." value={s.drugaNaziv} onChange={e => updateArrayItem('dodatniStroji', idx, 'drugaNaziv', e.target.value)} style={{marginTop:8}} className="fade-in" />}
                            </div>
                            <div style={{width: 140}}>
                                <TimeInput ure={s.ure} minute={s.minute} 
                                    hasError={s.naziv && !s.ure && !s.minute && validationErrors.length > 0}
                                    onChangeUre={v => updateArrayItem('dodatniStroji', idx, 'ure', v)}
                                    onChangeMinute={v => updateArrayItem('dodatniStroji', idx, 'minute', v)} />
                            </div>
                        </div>
                    )
                ))}
            </div>

            {/* MATERIALI */}
            <div className="card">
                <div className="section-title">
                    <Icon name="box" /> 4. Poraba materiala
                </div>
                {formData.materiali.map((m, idx) => (
                    (idx === 0 || formData.materiali[idx-1].material) && (
                        <div key={idx} className={idx > 0 ? "fade-in" : ""} style={{marginBottom: 16, borderBottom: '1px solid var(--gray-200)', paddingBottom: 16}}>
                            <div className="grid-3">
                                <select value={m.material} onChange={e => updateArrayItem('materiali', idx, 'material', e.target.value)}>
                                    <option value="">Izberi material...</option>
                                    {LISTS.materiali.map(x => <option key={x} value={x}>{x}</option>)}
                                </select>
                                <input type="number" placeholder="Količina" value={m.kolicina} 
                                    className={m.material && !m.kolicina && validationErrors.length > 0 ? 'error' : ''}
                                    onChange={e => updateArrayItem('materiali', idx, 'kolicina', e.target.value)} />
                                <select value={m.enota} onChange={e => updateArrayItem('materiali', idx, 'enota', e.target.value)}>
                                    <option value="">Enota</option>
                                    {LISTS.enote.map(x => <option key={x} value={x}>{x}</option>)}
                                </select>
                            </div>
                            {(m.material === 'Gnojilo' || m.material === 'Travno seme') && 
                                <input placeholder="Vrsta (npr. NPK 15-15-15)" value={m.vrsta} onChange={e => updateArrayItem('materiali', idx, 'vrsta', e.target.value)} style={{marginTop: 8}} className="fade-in" />
                            }
                            {m.material === 'Drugo' && 
                                <input placeholder="Vpiši naziv materiala..." value={m.drugMaterial} onChange={e => updateArrayItem('materiali', idx, 'drugMaterial', e.target.value)} style={{marginTop: 8}} className="fade-in" />
                            }
                        </div>
                    )
                ))}
            </div>

            {/* ODPADKI */}
            <div className="card">
                <div className="section-title">
                    <Icon name="trash" /> 5. Odpadki
                </div>
                {formData.odpadki.map((o, idx) => (
                    (idx === 0 || formData.odpadki[idx-1].vrsta) && (
                        <div key={idx} className={"grid-3 " + (idx > 0 ? "fade-in" : "")} style={{marginBottom: 16}}>
                            <select value={o.vrsta} onChange={e => updateArrayItem('odpadki', idx, 'vrsta', e.target.value)}>
                                <option value="">Vrsta odpadka...</option>
                                {LISTS.odpadki.map(x => <option key={x} value={x}>{x}</option>)}
                            </select>
                            <input type="number" placeholder="Količina" value={o.kolicina} 
                                className={o.vrsta && !o.kolicina && validationErrors.length > 0 ? 'error' : ''}
                                onChange={e => updateArrayItem('odpadki', idx, 'kolicina', e.target.value)} />
                            <select value={o.enota} onChange={e => updateArrayItem('odpadki', idx, 'enota', e.target.value)}>
                                <option value="">Enota</option>
                                {LISTS.enote.map(x => <option key={x} value={x}>{x}</option>)}
                            </select>
                        </div>
                    )
                ))}
            </div>

            {/* SLIKE */}
            <div className="card">
                <div className="section-title">
                    <Icon name="camera" /> 6. Slike s terena
                </div>
                <label className="upload-box">
                    <Icon name="camera" size={48} />
                    <span>Pritisni za dodajanje slik (največ 5)</span>
                    <input type="file" multiple accept="image/*" onChange={handleImageUpload} style={{display: 'none'}} />
                </label>
                <div className="img-grid">
                    {formData.slike.map((img, i) => (
                        <div key={i} className="img-preview fade-in">
                            <img src={img.data} alt="predogled" />
                            <button className="img-remove" onClick={() => setFormData(p => ({...p, slike: p.slike.filter((_, idx) => idx !== i)}))}>
                                <Icon name="close" size={16} />
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            {/* ZAKLJUČEK */}
            <div className="card">
                <div className="section-title">
                    <Icon name="check" /> Zaključek
                </div>
                
                <div style={{marginBottom: 20}}>
                    <label>Opombe</label>
                    <textarea rows="3" value={formData.opombe} onChange={e => updateField('opombe', e.target.value)} placeholder="Tukaj zapišite morebitne posebnosti, težave ali opažanja..."></textarea>
                </div>
                
                <div style={{marginBottom: 24}}>
                    <label>Podpis odgovornega delavca</label>
                    <select value={formData.podpisOdgovornega} onChange={e => updateField('podpisOdgovornega', e.target.value)} className={!formData.podpisOdgovornega && !formData.podpisDrugo && validationErrors.length ? 'error' : ''}>
                        <option value="">Izberi ime...</option>
                        {LISTS.delavci.filter(d => d !== 'Drugo').map(d => <option key={d} value={d}>{d}</option>)}
                        <option value="Drugo">Drugo</option>
                    </select>
                    {formData.podpisOdgovornega === 'Drugo' && 
                        <input placeholder="Vpiši ime in priimek" value={formData.podpisDrugo} onChange={e => updateField('podpisDrugo', e.target.value)} style={{marginTop: 12}} className="fade-in" />
                    }
                </div>

                {status.text && status.type === 'error' && (
                    <div className="fade-in" style={{
                        padding: '16px', borderRadius: '12px', marginBottom: '24px', textAlign: 'center', fontWeight: '600',
                        background: 'var(--danger-light)', color: '#991b1b', border: `1.5px solid #fca5a5`
                    }}>
                        {status.text}
                    </div>
                )}

                <div style={{position: 'relative'}}>
                    <button className="btn btn-primary" onClick={handleSubmit} disabled={loading} style={{padding: '20px', fontSize: '1.15rem', position: 'relative', zIndex: 2}}>
                        {loading ? '⏳ Obdelujem podatke...' : <><Icon name="send" /> Oddaj delovni nalog</>}
                    </button>
                    
                    {loading && (
                        <div className="fade-in" style={{marginTop: '16px', background: 'var(--gray-200)', borderRadius: '8px', overflow: 'hidden', height: '10px'}}>
                            <div style={{
                                width: `${uploadProgress}%`, height: '100%', background: 'var(--primary)', 
                                transition: 'width 0.2s linear', boxShadow: '0 0 10px rgba(133,181,69,0.5)'
                            }}></div>
                        </div>
                    )}
                    {loading && uploadProgress > 0 && (
                        <div style={{textAlign: 'center', fontSize: '0.85rem', color: 'var(--text-muted)', marginTop: '6px', fontWeight: '600'}}>
                            Nalagam podatke... {Math.round(uploadProgress)}%
                        </div>
                    )}
                </div>
                
                <button className="btn btn-secondary" disabled={loading} style={{marginTop: 24, background: 'transparent', border: 'none', color: 'var(--text-muted)'}} 
                    onClick={() => { if(confirm('Ste prepričani, da želite izbrisati vse vnešene podatke?')) { setFormData(INITIAL_STATE); setValidationErrors([]); window.scrollTo(0,0); } }}>
                    <Icon name="trash" size={20} /> Izbriši in začni znova
                </button>
            </div>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>